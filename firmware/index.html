



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="An open-source MIDI controlled loop switcher">
      
      
        <link rel="canonical" href="https://blemasle.github.io/mls800/firmware/">
      
      
        <meta name="author" content="Bertrand Lemasle">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Firmware - MLS800</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
<meta property="og:image" content="https://blemasle.github.io/mls800/assets/product-preview.png">

  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#firmware" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://blemasle.github.io/mls800/" title="MLS800" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                MLS800
              </span>
              <span class="md-header-nav__topic">
                Firmware
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/blemasle/mls800/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      blemasle/mls800
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://blemasle.github.io/mls800/" title="MLS800" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    MLS800
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/blemasle/mls800/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      blemasle/mls800
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hardware/" title="Hardware" class="md-nav__link">
      Hardware
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Firmware
      </label>
    
    <a href="./" title="Firmware" class="md-nav__link md-nav__link--active">
      Firmware
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#compiling" title="Compiling" class="md-nav__link">
    Compiling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupts" title="Interrupts" class="md-nav__link">
    Interrupts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-loop" title="Main loop" class="md-nav__link">
    Main loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#menu" title="Menu" class="md-nav__link">
    Menu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eeprom-memory-structure" title="EEPROM memory structure" class="md-nav__link">
    EEPROM memory structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loops-state" title="Loops state" class="md-nav__link">
    Loops state
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../building/" title="Building instructions" class="md-nav__link">
      Building instructions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../manual/" title="User Manual" class="md-nav__link">
      User Manual
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#compiling" title="Compiling" class="md-nav__link">
    Compiling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interrupts" title="Interrupts" class="md-nav__link">
    Interrupts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-loop" title="Main loop" class="md-nav__link">
    Main loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#menu" title="Menu" class="md-nav__link">
    Menu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eeprom-memory-structure" title="EEPROM memory structure" class="md-nav__link">
    EEPROM memory structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loops-state" title="Loops state" class="md-nav__link">
    Loops state
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/blemasle/mls800/edit/master/docs/firmware.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="firmware">Firmware<a class="headerlink" href="#firmware" title="Permanent link">&para;</a></h1>
<p>The project was developed using Arduino 1.6.x, and works with the latest version of Arduino and librairies. The traditional Arduino <code>.ino</code> is not an option to be followed for any project with some respect for clean code. As such, the projects is split across several files and ditching the Arduino IDE for more advanced one (VSCode, Visual Micro, &hellip;) is strongly recommended.</p>
<h2 id="compiling">Compiling<a class="headerlink" href="#compiling" title="Permanent link">&para;</a></h2>
<p>Install the required libraries through Arduino&rsquo;s Library Manager or with the following script. You can omit the version but just in case, those were the ones used to build the firmware.</p>
<div class="codehilite"><pre><span></span>arduino --install-library <span class="s2">&quot;AS1115:1.1.1&quot;</span>
arduino --install-library <span class="s2">&quot;E24:1.1.0&quot;</span>
arduino --install-library <span class="s2">&quot;MCP23017:1.0.1&quot;</span>
arduino --install-library <span class="s2">&quot;MIDI Library:4.3.1&quot;</span>
arduino --install-library <span class="s2">&quot;MIDIUSB:1.0.3&quot;</span>
</pre></div>

<p>Build the sketch with your IDE or by running <code>arduino --verify --board arduino:avr:micro src/MLS800.ino</code>.</p>
<h2 id="interrupts">Interrupts<a class="headerlink" href="#interrupts" title="Permanent link">&para;</a></h2>
<p>All of the ATmega32U4 external interrupts are used</p>
<table>
<thead>
<tr>
<th>Interrupt</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INT0</code>, <code>INT1</code></td>
<td>MIDI port</td>
</tr>
<tr>
<td><code>INT2</code>, <code>INT3</code></td>
<td>USB Serial port</td>
</tr>
<tr>
<td><code>INT6</code></td>
<td>User input <sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></td>
</tr>
</tbody>
</table>
<h2 id="main-loop">Main loop<a class="headerlink" href="#main-loop" title="Permanent link">&para;</a></h2>
<p>To offer the best response time possible to MIDI commands while playing, the main <code>loop</code> is kept simple and as fast as possible by not using any delays. Every delay needed - for instance for the user interface to blink - are run conditionally and use <code>millis()</code>.</p>
<h2 id="menu">Menu<a class="headerlink" href="#menu" title="Permanent link">&para;</a></h2>
<p>The MLS800 menu is kinda designed around the <a href="https://en.wikipedia.org/wiki/Command_pattern">action design pattern</a>. Each menu entry describes its content, its relation and how to respond to user inputs. For instance, pressing the <span class="keys"><kbd>Edit</kbd></span> key in some cases saves the changes and calls for a <code>back</code> action.<br />
That pattern keeps things tidy, easy to read and change while being memory efficient. It also nicely split the menu features implementation from its UI.</p>
<h2 id="eeprom-memory-structure">EEPROM memory structure<a class="headerlink" href="#eeprom-memory-structure" title="Permanent link">&para;</a></h2>
<p>The stock schematics use a 24LC256 which provides 256Kb of EEPROM memory. Currently, only the first half of that memory is used, and badly aligned. In reality, only a byte is needed to store a preset, but the original idea was to implement more complex patches that could respond to <code>Control Change</code> MIDI messages on top of changing patches with <code>Program Change</code>. That idea was never implemented, and 128 presets being more than enough for my use, the memory layout stayed that way.</p>
<table>
<thead>
<tr>
<th>Address</th>
<th>Name</th>
<th align="right">Size (bytes)</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>0x00</code></td>
<td>Main configuration</td>
<td align="right">17</td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>seed</code></td>
<td align="right">5</td>
<td>Used to detect invalid and/or blank configuration</td>
</tr>
<tr>
<td></td>
<td><code>version</code></td>
<td align="right">7</td>
<td>Version string</td>
</tr>
<tr>
<td></td>
<td><code>rxChannel</code></td>
<td align="right">1</td>
<td>MIDI Rx channel [<code>0</code>-<code>16</code>], <code>0</code> for Omni Mode</td>
</tr>
<tr>
<td></td>
<td><code>txChannel</code></td>
<td align="right">1</td>
<td>MIDI Tx channel [<code>0</code>-<code>16</code>], unused</td>
</tr>
<tr>
<td></td>
<td><code>patchNumber</code></td>
<td align="right">1</td>
<td>Active path number</td>
</tr>
<tr>
<td></td>
<td><code>currentState</code></td>
<td align="right">1</td>
<td>Current loops state</td>
</tr>
<tr>
<td></td>
<td><code>displayDim</code></td>
<td align="right">1</td>
<td>Display intensity [<code>0</code>-<code>15</code> ]</td>
</tr>
<tr>
<td><code>0x11</code></td>
<td>Reserved</td>
<td align="right">47</td>
<td></td>
</tr>
<tr>
<td><code>0x40</code></td>
<td>Patch <code>0</code></td>
<td align="right">129</td>
<td>Yep, this is bad design</td>
</tr>
<tr>
<td></td>
<td><code>data</code></td>
<td align="right">1</td>
<td>Patch <code>0</code> loops state</td>
</tr>
<tr>
<td></td>
<td><code>cc 0</code></td>
<td align="right">1</td>
<td><code>Control Change 0</code> sub state</td>
</tr>
<tr>
<td></td>
<td><code>...</code></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>cc 127</code></td>
<td align="right">1</td>
<td><code>Control Change 127</code> sub state</td>
</tr>
<tr>
<td><code>...</code></td>
<td></td>
<td align="right"></td>
<td></td>
</tr>
<tr>
<td><code>0x403F</code></td>
<td>Patch <code>128</code></td>
<td align="right">129</td>
<td>Last patch <sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup></td>
</tr>
</tbody>
</table>
<h2 id="loops-state">Loops state<a class="headerlink" href="#loops-state" title="Permanent link">&para;</a></h2>
<p>A loop state is mapped to a single byte, where each bit corresponds to the same loop number state (bit <code>0</code> to loop <code>0</code> etc). Sending the current state to reflect on the display is straightforward, but reflecting that state on audio loops is another story. </p>
<p>On the MCP23017, port A bits 0 to 7 turn loops 8 to 1 ON, while bits 0 to 7 turn loops 1 to 8 OFF on port B. Bits manipulation are fast and easy so priority has been given to PCB layout to keep traces parallel and avoid routing the audio signal from one side of the PCB to another.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>At the time of conception, <code>INT6</code> was unsupported by the Arduino framework. That explains code setting it up.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>But still plenty of room left&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../hardware/" title="Hardware" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Hardware
              </span>
            </div>
          </a>
        
        
          <a href="../building/" title="Building instructions" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Building instructions
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2019 <a href="https://github.com/blemasle">Bertrand Lemasle</a>
<br><span class="md-footer-custom-text">emoji provided free by </span><a href="http://www.emojione.com">EmojiOne</a>

          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/blemasle" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../uml.js"></script>
      
    
    
      
    
  </body>
</html>